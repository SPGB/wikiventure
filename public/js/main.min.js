/*! wikiventure 2014-01-28 */
var scenes,inventory,room,max_scenes_len=20,suggestions,last_action,cached_offset=0;$(document).ready(function(){function a(a){for(var b=a.toLowerCase().split(" "),c=b.length,d=["the","a"],e=0;c>e;e++)-1!==$.inArray(b[e],d)&&b.splice(e,1);return b.join(" ")}function b(){if(0!==$("#current_scene").length){for(var a=$(".text_container h2").html().split(" "),b=0;b<a.length;b++)if("!"===a[b][0]){var c="";a[b].indexOf(".")>0&&(a[b]=a[b].replace(".",""),c="."),a[b]='<span x-name="'+a[b].substr(1)+'">'+a[b].substr(1)+"</span>"+c}$(".text_container h2").html(a.join(" ")),window.scroll(0,document.body.scrollHeight)}}function c(a){inventory.push(a),$(".inventory_item.empty:first").html('<img src="img/'+a.name.replace(/\s+/g,"")+'.svg" />').removeClass("empty").attr("x-id",a._id)}function d(){$(".inventory_item:not(.empty)").addClass("empty").html("");for(var a=0;a<inventory.length;a++){var b=inventory[a];"object"==typeof b&&b._id&&$(".inventory_item.empty:first").html('<img src="img/'+b.name.replace(/\s+/g,"")+'.svg" />').removeClass("empty").attr("x-id",b._id)}}function e(a){$(".suggestion_box").text("");for(var b=0,c=0;c<suggestions.length;c++)-1===suggestions[c].indexOf(a)||""===a&&"begin"===suggestions[c]||($(".suggestion_box").append("<span>"+suggestions[c].replace(a,"<b>"+a+"</b>")+"</span>"),b++);1===b&&$(".suggestion_box span").addClass("active")}d(),b(),e(""),$(".alert").length>0&&$(".alert").text().length<15&&setTimeout(function(){$(".alert").fadeOut(1e3,function(){$(this).remove()})},3e3),$("body").on("mouseover",".inventory_item:not(.empty)",function(){$(".tooltip").hide();var a=$(this).attr("x-id");if($(".tooltip#"+a).length>0)$(".tooltip#"+a).show();else for(var b=0;b<inventory.length;b++){var c=inventory[b];if("object"==typeof c&&c._id===a){var d=$("<div />",{html:"<b>"+c.name+"</b><br />"+c.text+'<div class="triangle_right"></div>',"class":"tooltip",id:c._id});return $(this).append(d),void 0}}}),$("body").on("click","tr[x-href]",function(){return window.location=$(this).attr("x-href"),!1}),$("body").on("click",".suggestion_box span",function(){$("#your_action").val($(this).text()),$("#your_action").closest("form").submit()}),$("body").on("keyup keydown","#your_action",function(a){a.keyCode>=37&&a.keyCode<=40||(13===a.keyCode&&$(".suggestion_box span.active").length>0&&$("input#your_action").val($(".suggestion_box span.active").text()),e($.trim($("#your_action").val())))}),$(document).keydown(function(a){return 39===a.keyCode||40===a.keyCode?($(".suggestion_box span.active").removeClass("active").next().addClass("active"),0===$(".suggestion_box span.active").length&&$(".suggestion_box span:first").addClass("active"),!1):37===a.keyCode||38===a.keyCode?($(".suggestion_box span.active").removeClass("active").prev().addClass("active"),0===$(".suggestion_box span.active").length&&$(".suggestion_box span:last").addClass("active"),!1):void 0}),$("body").on("change",".auto_update select, .auto_update input",function(){$(this).closest("form").submit()}),$("body").on("click",".alert",function(){$(".alert").fadeOut(1e3,function(){$(this).remove()})}),$("input#your_action").val("").focus(),$("body").on("mouseover","span[x-name]",function(){if($(".tooltip:visible").hide(),$(".tooltip#examine_"+$(this).attr("x-name")).length>0)return $(".tooltip#examine_"+$(this).attr("x-name")).show(),!0;var a=$("<div />",{text:"examining","class":"tooltip examining",id:"examine_"+$(this).attr("x-name")});$(this).append(a);var b="current_scene"===$(this).parent("span").attr("id")?scenes[scenes.length-1]:scenes[scenes.length-2];$.ajax({url:"do",data:{action:"examine "+$(this).attr("x-name"),scenes:b},dataType:"JSON",type:"POST",success:function(a){return a.new_scene?($(".tooltip:visible").html('<b>No one has examined this before.</b><br>What do you think you would see?<form action="scene/'+a.new_msg._id+'" method="POST"><input type=hidden name="action" value="'+a.new_msg.action[0]+'"><input type=hidden name="room" value="'+room+'"><input type=hidden name="last_message" value="'+scenes[scenes.length-1]+'"><textarea value="text" name="text" placeholder="text"></textarea><div class="form_submit"><input type="submit" value="add it" /></div></form>'),$("h2 textarea").focus(),void 0):($(".tooltip.examining").html(a.text.split("\n").join("<br>")+'<a style="" id="edit" href="scene/'+a._id+'">edit</a>').removeClass("examining"),void 0)},error:function(){var a=$(".tooltip.examining").parent();$(".tooltip.examining").remove(),$(a).trigger("mouseover")}})}),$("body").on("click",".suggestion_right",function(){cached_offset-=250,$(".suggestion_box span:first").animate({"margin-left":cached_offset},250,"linear")}),$("body").on("click",".suggestion_left",function(){cached_offset+=250,cached_offset>0&&(cached_offset=0),$(".suggestion_box span:first").animate({"margin-left":cached_offset},250,"linear")}),$("body").on("click","#go_back",function(){return $("#new_scene").remove(),$("h2 #current_scene").show(),!1}),$("body").on("mouseout","span[x-name]",function(){$(".tooltip:visible").hide()}),$('form[action="do"]').submit(function(){return $(".alert").remove(),last_action=a($("input#your_action").val()),last_action.length<2||0===scenes.length&&"begin"!==last_action?($("input#your_action").css("border-top","2px solid red"),setTimeout(function(){$("input#your_action").css("border-top","1px solid #ddd")},3e3),$("input#your_action").val("").focus(),!1):("begin"===last_action&&(scenes=[],inventory=[],d(),$("#current_scene, #previous_scene").text("")),$.ajax({url:"do",data:{action:last_action,scenes:scenes.join(","),room:room,update:!0},dataType:"JSON",type:"POST",success:function(a){$(".suggestion_box").text(""),$("input#your_action").val("").focus(),cached_offset=0,a.new_scene&&($("h2 #current_scene").hide().after('<span id="new_scene"><b>No one has done this before!</b><br />Help make wikiventure amazing by adding to it!<br />Describe what happens when you <i>"'+a.new_msg.action[0]+'"</i><form action="scene/'+a.new_msg._id+'" method="POST"><input type=hidden name="action" placeholder="action" value="'+a.new_msg.action[0]+'"><input type=hidden name="last_message" placeholder="action" value="'+scenes[scenes.length-1]+'"><textarea value="text" name="text" placeholder="text"></textarea><div class="form_submit"><a href="/" id="go_back">back</a><input type="submit" value="add it" /></div></form></span>'),$("h2 textarea").focus()),a.room&&(room=a.room),a._id?(scenes.push(a._id),suggestions=a.suggestions,scenes.length>max_scenes_len&&($("body").append('<div class="alert">Wikiventure is just beginning. you have reached the furthest point currently in the game. <br /> type "begin" to start again</div>'),scenes=[]),a.text?($("#current_scene a").remove(),$("#previous_scene").append("<p>"+$("#current_scene").html()+"</p>"),$("#current_scene").html(a.text.split("\n").join("<br>")+'<a id="edit" style="" href="scene/'+a._id+'">edit</a>'),a.items.length>0&&(c(a.items[0]),$("#current_scene").prepend('<img src="img/'+a.items[0].name.replace(/\s+/g,"")+'.svg" class="size_medium" />'))):$("#current_scene").html('<i>no text :(<br>Please improve Wikiventure and add some.</i><form action="scene/'+a._id+'" method="POST"><input type=text name="action" placeholder="action" value="'+last_action+'"><br /><textarea value="text" name="text" placeholder="text"></textarea><br /><input type="submit" value="add it" /></form>')):suggestions=[],b(),e("")},error:function(){setTimeout(function(){$('form[action="do"]').submit()},2e3)}}),!1)})});